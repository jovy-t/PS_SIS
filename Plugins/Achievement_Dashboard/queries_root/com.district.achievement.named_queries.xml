<queries>
    <query name="com.district.achievement.get_levels" coreTable="STUDENTS" flattened="true">
        <summary>CUSD - Assessment Achievement Levels</summary>
        <description>Returns average state test achievement levels by grade and test name.</description>
        <args>
            <arg name="school_id" type="primitive" required="true" />
        </args>
        <columns>
            <column column="STUDENTS.DCID">academic_year</column>
            <column column="STUDENTS.ID">yearid</column>
            <column column="STUDENTS.LASTFIRST">test_name</column>
            <column column="STUDENTS.GRADE_LEVEL">grade_level</column>
            <column column="STUDENTS.STUDENT_NUMBER">avg_level</column>
        </columns>
        <sql><![CDATA[
                SELECT 
                academic_year,
                yearid,
                test_name,
                grade_level,
                avg_level
            FROM (
                SELECT 
                    (FLOOR(t.termid / 100) + 1991) AS academic_year,
                    (FLOOR(t.termid / 100) * 100) AS yearid,
                    catest.name AS test_name,
                    t.grade_level,
                    ROUND(AVG(CAST(s.value AS NUMBER)), 2) AS avg_level
                FROM s_ca_stu_test_s t
                JOIN s_ca_stu_testscore_c s ON t.id = s.s_ca_stu_test_sid
                JOIN s_ca_test_s catest ON t.testid = catest.id
                JOIN s_ca_testscore_c score_def ON s.testscoreid = score_def.id
                JOIN students stu ON t.studentid = stu.id
                WHERE stu.enroll_status = 0
                  AND s.value IS NOT NULL
                  AND score_def.description = 'Achievement Level'
                GROUP BY 
                    FLOOR(t.termid / 100), 
                    catest.name, 
                    t.grade_level
            )
            ORDER BY yearid DESC, test_name ASC, grade_level ASC
            ]]></sql>
    </query>
</queries>
