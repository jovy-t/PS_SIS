<queries>
    <query name="com.district.achievement.get_levels" coreTable="STUDENTS" summary="Cabrillo Aggregated Achievement Levels">
        <description>Returns average achievement levels for Cabrillo active students.</description>
        <args>
            <arg name="schoolid" type="primitive" default="~(curschoolid)" description="The school ID to filter by." />
        </args>
        <columns>
            <column column="S_CA_STU_TEST_S.GRADE_LEVEL">t.GRADE_LEVEL</column>
            <column column="S_CA_TEST_S.NAME">catest.TEST_NAME</column>
            <column column="AVG_ACH_LEVEL">AVG_ACH_LEVEL</column>
        </columns>
        <sql>
            <![CDATA[
                SELECT 
                    t.GRADE_LEVEL,
                    catest.NAME as TEST_NAME,
                    ROUND(AVG(TO_NUMBER(s.VALUE DEFAULT NULL ON CONVERSION ERROR)), 2) as AVG_ACH_LEVEL
                FROM S_CA_STU_TEST_S t
                JOIN S_CA_STU_TESTSCORE_C s ON t.ID = s.S_CA_STU_TEST_SID
                JOIN S_CA_TEST_S catest ON t.TESTID = catest.ID
                JOIN S_CA_TESTSCORE_C score_def ON s.TESTSCOREID = score_def.ID
                JOIN STUDENTS stu ON t.STUDENTID = stu.ID
                WHERE stu.ENROLL_STATUS = 0
                  AND s.VALUE IS NOT NULL
                  AND score_def.DESCRIPTION = 'Achievement Level'
                  AND t.TERMID BETWEEN 
                        (SELECT (FLOOR(MAX(ID)/100)*100) - 100 FROM TERMS WHERE FIRSTDAY <= SYSDATE AND LASTDAY >= SYSDATE)
                        AND 
                        (SELECT (FLOOR(MAX(ID)/100)*100) - 1 FROM TERMS WHERE FIRSTDAY <= SYSDATE AND LASTDAY >= SYSDATE)
                  AND (t.SCHOOLID = :schoolid OR :schoolid = 0)
                GROUP BY t.GRADE_LEVEL, catest.NAME
                ORDER BY catest.NAME, t.GRADE_LEVEL
            ]]>
        </sql>
    </query>
</queries>
